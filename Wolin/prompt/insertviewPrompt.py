import datetime
import logging

from Client.qwen import ez_llm
from jinja2 import Template

COMBINE_SLICE="""
## 背景
处理面试录音的ASR转化文本，它被滑动切片成多份文本，需要进行合并，合并过程中需要区分出面试官和求职者。

## 关键步骤
- 合并文本，融合掉重复内容
- 区分面试官和求职者的对话内容
- 基于基本信息对部分内容进行矫正

## 基本信息
{{resume_info}}

## 示例1
### 输入
["你好，欢迎来参加今天的面试。先简单介绍一下你自己吧，重点讲讲和这个岗位相关的工作或项目经历。您好，我叫李明，本科毕业于XX大学计算机专业，研究生在XX大学读了人工智能方向。我有三年多的产品经验，主要聚焦在AI产品与智能助手方向。最近两年，我在一家智能客服公司担任AI产品经理，负责智能对话系统与AI Agent相关产品的规划与落地，包括意图识别优化、多轮对话管理，以及基于大模型的新一代智能代理产品的设计。很高兴能来面试这个岗位。"
,"我在一家智能客服公司担任AI产品经理，负责智能对话系统与AI Agent相关产品的规划与落地，包括意图识别优化、多轮对话管理，以及基于大模型的新一代智能代理产品的设计。很高兴能来面试这个岗位。很好，你提到你负责过 AI Agent 类产品，可以具体说一下你做过最核心的一个项目吗？你在这个项目中承担了什么样的角色？
好的。我主导过一个基于大语言模型的“智能客服 Agent”项目，目标是让客服机器人不仅能解答常见问题，还能根据用户上下文做智能引导、任务拆解，甚至自主执行一些简单操作，比如查询订单、申请退款等。"]

### 输出
面试官：
你好，欢迎来参加今天的面试。先简单介绍一下你自己吧，重点讲讲和这个岗位相关的工作或项目经历。
求职者：
您好，我叫李明，本科毕业于XX大学计算机专业，研究生在XX大学读了人工智能方向。我有三年多的产品经验，主要聚焦在AI产品与智能助手方向。最近两年，我在一家智能客服公司担任AI产品经理，负责智能对话系统与AI Agent相关产品的规划与落地，包括意图识别优化、多轮对话管理，以及基于大模型的新一代智能代理产品的设计。很高兴能来面试这个岗位。
面试官：
很好，你提到你负责过 AI Agent 类产品，可以具体说一下你做过最核心的一个项目吗？你在这个项目中承担了什么样的角色？
求职者：
好的。我主导过一个基于大语言模型的“智能客服 Agent”项目，目标是让客服机器人不仅能解答常见问题，还能根据用户上下文做智能引导、任务拆解，甚至自主执行一些简单操作，比如查询订单、申请退款等。

"""


REPORT_PROMPT="""
## 目标
基于学生和面试官的对话记录，基于评价规则生成指定JSON结构。

## 生成规则
- 作出评价需要尽可能援引对话记录，阐释为什么给出结论
- 生成python格式的dict 所有的value改成str类型

## 评价规则
- 对话总轮数 指学生与面试官之间的问答轮次总量，反映面试深入程度
- 是否有完整流程 是否涵盖：自我介绍 → 项目/技术讨论 → 业务/场景题 → 反问环节
- 学生发言占比 学生是否主动表达、阐述观点，还是被动应答
- 技术问题数量 面试官是否提问了与岗位相关的专业问题（如算法、系统设计、产品逻辑等）
- 问题难度 技术问题属于基础、中等还是高级/开放型问题
- 学生回答深度 学生是否能清晰阐述思路、结合案例、分析权衡、展示逻辑
- 技术匹配度 学生回答是否贴合目标岗位所需技能（如AI Agent岗位是否谈模型/任务拆解/多轮对话）
- 是否主动介绍项目 学生是否主动提及自己的核心项目，而非仅回答面试官提问
- 项目描述清晰度 项目背景、目标、本人角色、做了什么、结果如何，是否逻辑清晰
- 项目与岗位匹配度 项目经验是否与应聘岗位相关（如AI产品经理岗位与AI Agent相关项目）
- 项目难点与解决 是否提到项目中的挑战、自己的思考与解决办法
- 语言表达清晰度 表达是否流畅、有逻辑、有条理，是否口头禅过多（如“嗯”“然后”）
- 逻辑结构 回答是否有总分总、先结论后展开等逻辑结构
- 互动与反馈 是否根据面试官反馈调整表达，是否善于倾听、互动回应
- 语言专业度 是否使用一定专业术语但不过度堆砌，表达是否得体
- 面试官追问深度 面试官是否针对某个问题深入追问（如技术细节、项目难点、选择原因）
- 面试官引导性语言 是否有鼓励、肯定语言，如“很好”“不错”“这个想法有意思”
- 是否给学生表达空间 面试官是否给学生足够时间表达观点，还是频繁打断/主导对话
- 是否提问 学生是否在最后主动提问（反问面试官）
- 问题质量 提问是否体现思考深度，如关于团队、业务方向、技术挑战、成长路径等
- 是否体现岗位兴趣 提问是否能体现学生对岗位、业务的关注与热情
- 岗位匹配度 学生的经历、技能、兴趣是否与目标岗位高度契合
- 整体印象 综合所有维度，面试官可能会给学生打出怎样的第一印象
- 面试成功率预测 基于以上所有分析，综合判断该学生通过面试的可能性

## 示例输出
{
  "对话总轮数": "18",
  "是否有完整流程": "是",
  "学生发言占比": "58%",
  "技术问题数量": "7",
  "问题难度": "中等",
  "学生回答深度": "较深，能结合实习项目说明技术选型原因，并对比不同方案的优劣",
  "技术匹配度": "高，多次提到大模型调用、工具调度和上下文工程，贴合AI Agent岗位要求",
  "是否主动介绍项目": "是",
  "项目描述清晰度": "清晰，明确说明了项目背景（校园智能问答系统）、个人角色（后端+Agent逻辑设计）、关键技术（LangChain + 自定义记忆模块）及最终效果（准确率提升22%）",
  "项目与岗位匹配度": "高度相关，项目涉及多轮对话管理、意图识别和工具调用，与应聘的AI Agent工程师岗位契合",
  "项目难点与解决": "提到了上下文长度限制导致信息丢失的问题，通过引入摘要式中期记忆机制缓解，并做了A/B测试验证效果",
  "语言表达清晰度": "流畅，偶有“那个”但不影响理解，语速适中",
  "逻辑结构": "多数回答采用‘结论先行+分点阐述’结构，如‘我主要做了三件事：第一…第二…第三…’",
  "互动与反馈": "能根据面试官追问调整回答细节，例如在被问到‘为什么不用AutoGen？’时补充了框架定制灵活性的考量",
  "语言专业度": "使用了如‘RAG’、‘Function Calling’、‘状态机’等术语，但会简要解释，不堆砌",
  "面试官追问深度": "较深，针对项目中的记忆模块设计连续追问了3轮，包括缓存策略、错误恢复机制等",
  "面试官引导性语言": "有，如‘这个思路很清晰’、‘可以再展开说说吗？’、‘不错，考虑得很全面’",
  "是否给学生表达空间": "是，平均每次学生发言持续40秒以上，面试官极少打断",
  "是否提问": "否",
  "问题质量": "高质量，问了‘团队目前在Agent方向上最关注的技术瓶颈是什么？’和‘新人入职后前3个月的主要成长路径？’",
  "是否体现岗位兴趣": "明显体现，提问聚焦Agent架构演进和团队技术栈，表现出强烈兴趣",
  "岗位匹配度": "非常高，技术栈、项目经验、学习方向均与岗位JD高度一致",
  "整体印象": "积极主动、逻辑清晰、技术扎实、对AI Agent有真实热情，具备良好沟通能力和工程思维",
  "面试成功率预测": "高（约85%），建议进入下一轮或直接发offer"
}
"""

test = """
面试官：  
那个你在哪里过来？  
求职者：  
从深圳南山区白石洲那里。  
面试官：  
哦，你住那边是吧？  
求职者：  
对。  
面试官：  
哦，你家都住那边是吧？  
求职者：  
是，就是家里有人在租房子。  
面试官：  
哎，你本科是在天津嘛是吧？  
求职者：  
对，是。  
面试官：  
你是从深圳考过去还是什么？  
求职者：  
就从深圳考过去。  
面试官：  
你是深圳人吗？  
求职者：  
嗯，算是，就是但是家里老家是广东梅州那里。  
面试官：  
哦，近，梅州那里。  
求职者：  
对，也是广东省内，然后家里人是从90年代就来深圳打工。  
面试官：  
哎，你为啥考的是天津？  
求职者：  
一是因为广东省当时211里最低的是华南师范大学，我差三分没考上；二是想去北方看看，之前没怎么去过北方，想扩大视野和眼界。所以选了天津财经大学，既能学财经类专业，又能拓宽视野。  

面试官：  
然后我看你又在山东工作。  
求职者：  
对，因为大学在北方比较好找工作。  

（中间插话略过）  

面试官：  
那你自己先简单介绍一下呗。  
求职者：  
OK。面试官您好，我叫朱行江，2024年6月毕业于天津财经大学。2024年1月起在山东省智联智慧信息服务有限公司实习，从事大数据相关岗位。  
一开始实习几个月学习大数据知识，之后被分配到一个基金APP开发项目，主要负责“涨跌幅提醒功能”的开发。具体包括基金自身的当日、近期、近30天涨跌幅，同类平均比较基准的相应指标，以及比较基准本身的三类指标，共九个小指标。该项目主要使用Oracle编写存储过程实现。  

完成基金APP项目后，我被调入一个电商项目，技术栈以Hive数仓为主，目标是提升数据查询效率，并优化商品转化率与新用户激活问题。我主要负责平台留存率和商品漏斗转化率的指标开发，用于分析运营环节的问题及拉新留存策略。  

项目结束后没有新任务，我就离职了。  

我会的技术栈包括：Oracle、MySQL、Hive（Hadoop体系）、Doris数据库，以及Sqoop、Kettle等ETL工具，还用过Azkaban任务调度工具，熟悉Linux环境。  

个人优点是自驱力强、学习能力强，有终身学习意识，具备良好的团队协作与沟通能力，积极主动，愿意承担任务、帮助公司解决问题。  

这就是我的简单自我介绍，谢谢面试官，期待后续交流！  

面试官：  
好，关于数据开发岗位，你应该了解我们要招的是数据开发人员，同时要懂一些数据治理相关知识。能不能结合具体例子，说说你在数据治理方面做过哪些工作？比如遇到过哪些数据质量问题或架构标准问题，你具体做了什么？  

求职者：  
好的。我在基金APP项目中遇到两个数据库——万得和聚源——的数据不一致问题。  
一是交易时间格式不同：聚源是标准时间格式，万得是字符串格式。我们统一用to_char(yyyymmdd)将聚源转为字符串格式。  
二是基金代码不一致：万得是“数字.of”格式，聚源是纯数字。我们用正则表达式截取数字部分，统一为纯数字编码。  

在电商项目中，也遇到商品ID如“P001”和“001”并存的问题，导致数据发散。我们同样用正则去掉前缀字母，保留纯数字，并通过WHERE条件去重，只保留最新一条记录。  

面试官：  
你有没有参与过系统建设初期的数据标准或模型设计？比如和业务一起识别质量问题、制定标准？  

求职者：  
有的。我们在建模时采用了星型模型——一个事实表加多个维度表。我也参与过数据质量标准的讨论，比如字段粒度统一、计算逻辑一致、维度对齐等。不过主要设计由架构师和项目经理主导，我们作为开发人员参与讨论。  

面试官：  
我们这个岗位叫“数据管家”，兼具数据架构师职责，要对整个信息化系统的数据全生命周期负责。你能不能讲讲你对数据治理的理解？构建态和运行态的关键点有哪些？  

求职者：  
我认为数据治理核心是“盘、规、治、用”：  
- **盘**：盘点数据源、标准、链路；  
- **规**：制定数据标准体系；  
- **治**：建立事前标准、事中监控、事后分析修复机制；  
- **用**：释放数据价值，支撑应用。  

参考华为的数据治理体系，它是业务驱动、价值为纲，由业务系统负责人作为Owner，数据管家执行治理。关键包括：  
- **事前**：统一字段命名，避免一词多义或同词多义；统一计算逻辑；做好维度建模；确保数据的**唯一性**（如商品ID主键唯一）、**有效性**（如销量≤库存）、**完整性**（关键字段如客户名称、电话不能缺失）。  
- **事中**：监控数仓运行流程，确保各层表字段数量、列名一致，保证**一致性**。  
- **事后**：问题溯源、按业务规则修复、输出治理报告，并将成果纳入KPI考核。  

此外还有元数据管理：业务元数据（数据源、业务含义）、技术元数据（表结构）、操作元数据（操作人、时间）。  

面试官：  
我看你专业是金融，第一份工作却偏技术，为什么？  

求职者：  
大一大二时金融行业已开始数字化转型，需要“金融+数据”的复合人才。我在校选修了Oracle课程，产生兴趣。大四咨询就业老师，得知大数据前景好，于是转向该方向实习就业。  

另外，2023–2024年经济环境不好，证券市场低迷，纯金融就业面窄、质量不高。结合技术背景找工作更有优势，这也是现实考量。  

面试官：  
那你长期职业规划是什么？如果明年金融回暖，你会回去吗？  

求职者：  
实事求是地说，我已在数据开发领域工作一年有余，积累了一定技术和业务经验。若转回纯金融，等于从零开始，需重新学习理论、适应岗位，成本高、风险大。  
考虑到沉没成本和已有积累，我更愿意在当前方向深耕。  

面试官：  
那你未来想成为什么样的专家？  

求职者：  
希望成为**全链路数据开发专家**：  
- 熟悉维度建模、指标体系构建、业务流程；  
- 掌握数仓分层（ODS/DWD/DWS/ADS）开发；  
- 补齐实时数仓技术（目前主要做离线）；  
- 精通BI报表开发，能应对企业多样化需求。  

面试官：  
介绍一下你的项目团队构成、你的角色、上下游协作情况。  

求职者：  
以电商项目为例：团队共9人——1名数据架构师兼项目经理、3名数据开发（含我）、2名数据分析师、1名BI工程师、1名测试、1名运维。  

项目背景：客户是中小电商，原用Excel手工同步，数据量增大后建数仓。我加入时项目刚启动约两个月，处于0→1阶段。  

数仓分五层：  
1. **ODS**：贴源层，保留原始数据，加抽取时间和系统标识，便于溯源；  
2. **DWD**：明细层，做清洗、格式统一、脏数据过滤，建维度表和事实表；  
3. **DWS**：聚合层，按日粒度轻度汇总，分主题域（我负责商品域和用户域）；  
4. **Doris层**：将DWD/DWS数据ETL至Doris，提升查询效率；  
5. **ADS**：应用层，在Doris上输出标准化指标和报表，供管理层使用。  

面试官：  
项目中遇到过哪些关键挑战？  

求职者：  
主要有三类问题：  
1. **数据倾斜**：分析商品漏斗转化率时，爆款商品点击量极大，导致Reduce阶段卡在99%。我们通过日志定位热点Key，采用“给商品ID加随机后缀→拆分→聚合→合并”方式解决。  
2. **数据发散**：商品ID存在“P001”和“001”两种形式，统一格式并去重后解决。  
3. **数据漂移**：用户登录时间用UTC，导致22–23点行为被记到次日。我们统一转换为北京时间（UTC+8）修正。  

日均数据量约1000万条。  

面试官：  
你们公司是外包？规模多大？  

求职者：  
是接大数据项目的外包公司，注册资本100–200万。我们数据团队9人，专注数据开发，不做上层应用。项目制签约（半年或一年），正规缴纳社保、发薪。我8月底离职，因项目结束且无新项目。9月中下旬复盘总结，10月9日后开始投简历。  

面试官：  
你自驱力强体现在哪？  

求职者：  
我会主动提前完成任务。比如一周 deadline，我会拆解进度，争取提前几天交付，避免拖延。  

面试官：  
有看数据治理相关书籍吗？比如《华为数据治理之道》？  

求职者：  
了解过简介，但未细读。近期在求职，时间有限，优先准备面试内容。  

面试官：  
你期望薪资多少？  

求职者：  
上一份税前10k，希望本次有小幅上浮至11–12k。因为我已具备岗位所需技术能力，且愿意深入学习华为数据治理体系，快速投入数据治理工作，创造额外价值。  

面试官：  
这个岗位偏数据治理，数仓开发较少，更多是分析侧开发，也可能涉及AI训练/微调数据集准备。你负责的业务系统主要是CRM（线索→销售→机会点→合同→服务履行），属华为数字能源板块（光伏、储能、智能电动等）。具体分工入职后再定。  

求职者：  
明白，感谢说明！  

面试官：  
正常一周内出结果。你还有什么问题？  

求职者：  
没有了，谢谢！  

面试官：  
好的，先这样。出门时记得佩戴好物品。  

求职者：  
好的，拜拜！
"""


CORE_QA_EXTRACT_PROMPT ="""
基于求职者与面试官的面试问答对，提取出技术相关的核心问题

以数组的形式返回，每个元素为技术问题的一组问答对，可能会存在一种情况，一个技术问题包含多轮问答。

## 输出示例
[
  {
    "question": "能不能结合具体例子，说说你在数据治理方面做过哪些工作？比如遇到过哪些数据质量问题或架构标准问题，你具体做了什么？",
    "answer": "我在基金APP项目中遇到两个数据库——万得和聚源——的数据不一致问题。一是交易时间格式不同：聚源是标准时间格式，万得是字符串格式。我们统一用to_char(yyyymmdd)将聚源转为字符串格式。二是基金代码不一致：万得是“数字.of”格式，聚源是纯数字。我们用正则表达式截取数字部分，统一为纯数字编码。在电商项目中，也遇到商品ID如“P001”和“001”并存的问题，导致数据发散。我们同样用正则去掉前缀字母，保留纯数字，并通过WHERE条件去重，只保留最新一条记录。"
  },
  {
    "question": "你有没有参与过系统建设初期的数据标准或模型设计？比如和业务一起识别质量问题、制定标准？",
    "answer": "有的。我们在建模时采用了星型模型——一个事实表加多个维度表。我也参与过数据质量标准的讨论，比如字段粒度统一、计算逻辑一致、维度对齐等。不过主要设计由架构师和项目经理主导，我们作为开发人员参与讨论。"
  },
  {
    "question": "我们这个岗位叫“数据管家”，兼具数据架构师职责，要对整个信息化系统的数据全生命周期负责。你能不能讲讲你对数据治理的理解？构建态和运行态的关键点有哪些？",
    "answer": "我认为数据治理核心是“盘、规、治、用”：- **盘**：盘点数据源、标准、链路；- **规**：制定数据标准体系；- **治**：建立事前标准、事中监控、事后分析修复机制；- **用**：释放数据价值，支撑应用。参考华为的数据治理体系，它是业务驱动、价值为纲，由业务系统负责人作为Owner，数据管家执行治理。关键包括：- **事前**：统一字段命名，避免一词多义或同词多义；统一计算逻辑；做好维度建模；确保数据的**唯一性**（如商品ID主键唯一）、**有效性**（如销量≤库存）、**完整性**（关键字段如客户名称、电话不能缺失）。- **事中**：监控数仓运行流程，确保各层表字段数量、列名一致，保证**一致性**。- **事后**：问题溯源、按业务规则修复、输出治理报告，并将成果纳入KPI考核。此外还有元数据管理：业务元数据（数据源、业务含义）、技术元数据（表结构）、操作元数据（操作人、时间）。"
  },
  {
    "question": "介绍一下你的项目团队构成、你的角色、上下游协作情况。",
    "answer": "以电商项目为例：团队共9人——1名数据架构师兼项目经理、3名数据开发（含我）、2名数据分析师、1名BI工程师、1名测试、1名运维。项目背景：客户是中小电商，原用Excel手工同步，数据量增大后建数仓。我加入时项目刚启动约两个月，处于0→1阶段。数仓分五层：1. **ODS**：贴源层，保留原始数据，加抽取时间和系统标识，便于溯源；2. **DWD**：明细层，做清洗、格式统一、脏数据过滤，建维度表和事实表；3. **DWS**：聚合层，按日粒度轻度汇总，分主题域（我负责商品域和用户域）；4. **Doris层**：将DWD/DWS数据ETL至Doris，提升查询效率；5. **ADS**：应用层，在Doris上输出标准化指标和报表，供管理层使用。"
  },
  {
    "question": "项目中遇到过哪些关键挑战？",
    "answer": "主要有三类问题：1. **数据倾斜**：分析商品漏斗转化率时，爆款商品点击量极大，导致Reduce阶段卡在99%。我们通过日志定位热点Key，采用“给商品ID加随机后缀→拆分→聚合→合并”方式解决。2. **数据发散**：商品ID存在“P001”和“001”两种形式，统一格式并去重后解决。3. **数据漂移**：用户登录时间用UTC，导致22–23点行为被记到次日。我们统一转换为北京时间（UTC+8）修正。日均数据量约1000万条。"
  }
]
"""

CORE_QA_ANALYSIS_PROMPT = """
基于求职者与面试官的技术相关的面试问答对，对求职者的答案进行点评以及修改建议

以 analysis 字段追加到入参的原始dict中

## 规则
- 换行符请转义

## 输出示例
[
  {
    "question": "能不能结合具体例子，说说你在数据治理方面做过哪些工作？比如遇到过哪些数据质量问题或架构标准问题，你具体做了什么？",
    "answer": "我在基金APP项目中遇到两个数据库——万得和聚源——的数据不一致问题。一是交易时间格式不同：聚源是标准时间格式，万得是字符串格式。我们统一用to_char(yyyymmdd)将聚源转为字符串格式。二是基金代码不一致：万得是“数字.of”格式，聚源是纯数字。我们用正则表达式截取数字部分，统一为纯数字编码。在电商项目中，也遇到商品ID如“P001”和“001”并存的问题，导致数据发散。我们同样用正则去掉前缀字母，保留纯数字，并通过WHERE条件去重，只保留最新一条记录。",
    "analysis": "回答结构清晰，列举了两个项目中典型的数据质量问题（时间格式、基金代码、商品ID），并说明了解决方法（to_char、正则表达式、去重逻辑），体现了实际动手能力。\\n缺乏对问题影响的量化描述（如不一致导致报表错误率多少？业务损失？），也未体现是否推动形成标准或流程固化。例如，统一后的格式是否写入数据字典？是否有校验规则防止再次出现？\\n建议补充：① 问题造成的业务影响；② 解决方案是否沉淀为规范（如ETL脚本模板、数据清洗规则库）；③ 是否通过元数据或质量监控工具实现长效治理。"
  }
]
"""
test2 = [
  {
    "question": "能不能结合具体例子，说说你在数据治理方面做过哪些工作？比如遇到过哪些数据质量问题或架构标准问题，你具体做了什么？",
    "answer": "我在基金APP项目中遇到两个数据库——万得和聚源——的数据不一致问题。一是交易时间格式不同：聚源是标准时间格式，万得是字符串格式。我们统一用to_char(yyyymmdd)将聚源转为字符串格式。二是基金代码不一致：万得是“数字.of”格式，聚源是纯数字。我们用正则表达式截取数字部分，统一为纯数字编码。在电商项目中，也遇到商品ID如“P001”和“001”并存的问题，导致数据发散。我们同样用正则去掉前缀字母，保留纯数字，并通过WHERE条件去重，只保留最新一条记录。"
  },
  {
    "question": "你有没有参与过系统建设初期的数据标准或模型设计？比如和业务一起识别质量问题、制定标准？",
    "answer": "有的。我们在建模时采用了星型模型——一个事实表加多个维度表。我也参与过数据质量标准的讨论，比如字段粒度统一、计算逻辑一致、维度对齐等。不过主要设计由架构师和项目经理主导，我们作为开发人员参与讨论。"
  },
  {
    "question": "我们这个岗位叫“数据管家”，兼具数据架构师职责，要对整个信息化系统的数据全生命周期负责。你能不能讲讲你对数据治理的理解？构建态和运行态的关键点有哪些？",
    "answer": "我认为数据治理核心是“盘、规、治、用”：- **盘**：盘点数据源、标准、链路；- **规**：制定数据标准体系；- **治**：建立事前标准、事中监控、事后分析修复机制；- **用**：释放数据价值，支撑应用。参考华为的数据治理体系，它是业务驱动、价值为纲，由业务系统负责人作为Owner，数据管家执行治理。关键包括：- **事前**：统一字段命名，避免一词多义或同词多义；统一计算逻辑；做好维度建模；确保数据的**唯一性**（如商品ID主键唯一）、**有效性**（如销量≤库存）、**完整性**（关键字段如客户名称、电话不能缺失）。- **事中**：监控数仓运行流程，确保各层表字段数量、列名一致，保证**一致性**。- **事后**：问题溯源、按业务规则修复、输出治理报告，并将成果纳入KPI考核。此外还有元数据管理：业务元数据（数据源、业务含义）、技术元数据（表结构）、操作元数据（操作人、时间）。"
  },
  {
    "question": "介绍一下你的项目团队构成、你的角色、上下游协作情况。",
    "answer": "以电商项目为例：团队共9人——1名数据架构师兼项目经理、3名数据开发（含我）、2名数据分析师、1名BI工程师、1名测试、1名运维。项目背景：客户是中小电商，原用Excel手工同步，数据量增大后建数仓。我加入时项目刚启动约两个月，处于0→1阶段。数仓分五层：1. **ODS**：贴源层，保留原始数据，加抽取时间和系统标识，便于溯源；2. **DWD**：明细层，做清洗、格式统一、脏数据过滤，建维度表和事实表；3. **DWS**：聚合层，按日粒度轻度汇总，分主题域（我负责商品域和用户域）；4. **Doris层**：将DWD/DWS数据ETL至Doris，提升查询效率；5. **ADS**：应用层，在Doris上输出标准化指标和报表，供管理层使用。"
  },
  {
    "question": "项目中遇到过哪些关键挑战？",
    "answer": "主要有三类问题：1. **数据倾斜**：分析商品漏斗转化率时，爆款商品点击量极大，导致Reduce阶段卡在99%。我们通过日志定位热点Key，采用“给商品ID加随机后缀→拆分→聚合→合并”方式解决。2. **数据发散**：商品ID存在“P001”和“001”两种形式，统一格式并去重后解决。3. **数据漂移**：用户登录时间用UTC，导致22–23点行为被记到次日。我们统一转换为北京时间（UTC+8）修正。日均数据量约1000万条。"
  }
]

ANALYSIS_START_PROMPT = """
800字以内总结求职者的面试效果,求职者其实是培训班出来的，观察求职者是否已经受到了面试官的怀疑

禁止使用MarkDown格式，只允许使用纯文本和换行符
"""

INTERVIEW_EVALUATION_PROMPT = """
假设你是下面对话记录中的面试官,请你总结出你对求职者的评价 

## 注意事项
- 判断求职者是否存在培训背景（回答偏模板化、缺乏对业务的结合可以视为偏培训背景）
- 评价求职者的沟通表达能力
- 是否愿意给他下一轮面试的机会（提供论据）
- 回复500字以内,禁止使用MarkDown格式

## 参考内容
{{analysis_start}}
"""

SELF_EVALUATION_PROMPT = """
假设你是下面对话记录中的求职者,请你总结出你对自己的评价,以及应该如何改进，并且列举出哪些回答是可以优化的。

## 规则
- 禁止使用MarkDown格式, 禁止 **content** 形式的格式

## 输出示例
我对自己的评价是：具备扎实的数据开发技术基础，熟悉主流数仓架构和ETL流程，在项目中能独立承担核心模块开发，并对数据治理有初步理解和实践经验。同时，我有较强的自驱力、学习意愿和现实导向的职业判断，能够根据市场环境和个人积累做出理性选择。

但我也意识到存在明显不足：  
一是对数据治理的理解偏理论化，缺乏系统性实践，尤其在标准制定、跨部门协同、治理落地闭环等方面经验薄弱；  
二是回答问题时部分表述过于简略或被动，比如“项目结束后没有新任务，我就离职了”显得缺乏主动性；  
三是对行业经典书籍和方法论准备不足，如未深入阅读《华为数据治理之道》，影响专业深度展现；  
四是职业动机解释虽诚实，但可更突出长期承诺而非仅强调“沉没成本”。

可以优化的回答包括：  

1. 关于离职原因：“项目结束后没有新任务，我就离职了”应改为更积极的表达，例如“在完成两个核心项目后，我希望接触更复杂、持续性的数据治理体系，因此主动寻求能长期参与数据全生命周期管理的机会。”  

2. 关于数据治理经验：当被问及是否参与标准制定时，仅说“主要由架构师主导，我们参与讨论”显得被动。可补充具体贡献，如“我在讨论中提出商品ID统一规则的建议，并推动在DWD层落地实施，减少了后续分析中的歧义。”  

3. 关于读书与学习：面对“是否看过《华为数据治理之道》”的问题，不应只说“了解简介但未细读”，而应展示学习计划，如“目前正在系统学习该书框架，并结合面试准备梳理了‘盘规治用’在实际项目中的映射点，入职后希望能快速应用。”  

4. 自我介绍结尾：结束语“期待后续交流”较平淡，可强化匹配度，如“我的技术栈和对数据治理的理解与贵岗位‘数据管家’的定位高度契合，希望能加入团队共同构建高质量数据资产。”  

5. 职业规划回答：提到“不会回金融”时侧重成本考量，略显功利。可调整为“经过一年实战，我确认自己热爱数据工作，尤其享受通过数据建模解决业务问题的过程，未来希望在数据价值释放这条路上持续深耕。”  

总体而言，我需要在保持真诚的同时，提升回答的战略性、主动性和专业纵深感，避免被动陈述，更多体现思考、行动与成长潜力。
"""

ANALYSIS_END_PROMPT = """
基于参考内容和面试对话记录进行总结

## 内容
- 概括总结参考内容和对话记录
- 指出求职者一些存在的问题,并给出改进建议
- 引用一些名人名言或者美好的话，温柔的鼓励求职者

## 规则
- 禁止使用MarkDown格式, 禁止 **content** 形式的格式
- 分三个段落生成【内容】,不需要额外的标题

## 参考内容
{{analysis_start}}
"""


RESUME_JSON_EXTRACT_PROMPT = """
基于求职者简历，提取出指定信息，以JSON形式返回

name: 求职者姓名
age: 求职者年龄
sex: 求职者性别
education: 求职者教育背景
graduation_time: 求职者毕业时间
major: 求职者专业
last_company: 求职者上一份工作公司
last_position: 求职者上一份工作职位
last_salary: 求职者上一份工作薪资
last_start_time: 求职者上一份工作开始时间
last_end_time: 求职者上一份工作结束时间
last_duration: 求职者上一份工作工作时长
intent_position: 求职者期望工作职位

## 示例输出
{
  "name": "李明",
  "age": 28,
  "sex": "男",
  "education": "清华大学-本科 清华大学-硕士研究生",
  "graduation_time": "2020-06",
  "major": "计算机科学与技术",
  "last_company": "星辰科技有限公司",
  "last_position": "高级后端开发工程师",
  "last_salary": 25000,
  "last_start_time": "2020-07",
  "last_end_time": "2024-10",
  "last_duration": "4年3个月",
  "intent_position": "技术经理"
}
"""


RESUME_ANALYSIS_PROMPT = f"""
## 背景
基于求职者简历，对求职者的简历进行评价，并给出改进建议

## 规则
- 禁止使用MarkDown格式, 禁止生成 **content** 形式的格式
- 如果参考内容存在面试总结，请基于面试总结对简历提出修改建议
- 判断是否存在工作量与项目周期不匹配的情况
- 判断是否工作内容缺乏深度
- 检查是否存在错别字以及无效赘述
- 当前时间: {datetime.datetime.now()}


## 参考内容
{{analysis_start}}
"""

def render(prompt, params):
    template = Template(prompt)
    return template.render(params)

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    params = {
        "analysis_start" : """
求职者整体表现较为流畅，自我介绍结构清晰，项目细节描述具体，能结合技术栈与业务场景展开说明，展现出一定的数据开发实操经验。在回答数据治理相关问题时，引用了“盘、规、治、用”框架，并提及华为治理体系，显示出对岗位要求的提前准备。

然而，面试官可能已对其背景产生一定怀疑。首先，其教育背景（天津财经大学金融专业）与从事的大数据开发工作跨度较大，虽解释为“兴趣+就业现实”，但缺乏系统性学习路径佐证。其次，在被问及是否阅读《华为数据治理之道》等专业书籍时，回答“了解过简介但未细读”，与其声称深入研究华为体系的说法存在矛盾，暴露出知识储备可能来自短期培训而非长期积累。

此外，项目经历虽详尽，但细节过于“标准答案化”——如星型模型、五层数仓、数据倾斜解决方案等表述高度模板化，缺乏真实项目中常见的个性化挑战或协作摩擦。团队构成、技术选型、问题处理方式均符合培训机构常见案例范式，进一步强化了“培训班出身”的印象。

面试官虽未直接质疑，但在追问“是否参与系统初期标准制定”“职业规划是否稳定”等问题时，语气和问题深度已隐含对其真实经验与长期适配性的审视。求职者虽努力强调沉没成本与职业决心，但逻辑略显生硬，未能完全打消疑虑。

综上，求职者面试效果中等偏上，表达自信、准备充分，但因背景转换突兀、知识呈现套路化，已引起面试官潜在怀疑，后续能否通过将取决于背调结果或技术笔试验证。
        """
    }
    prompt = render(ANALYSIS_END_PROMPT,{})
    res = ez_llm(prompt,test)
    print(res)