import json
import os
import tempfile
from docxtpl import DocxTemplate


def generate_doc_with_jinja(template_path, context):
    """
    使用 docxtpl 生成 Word 文档，并保存到临时文件夹，返回文件路径。
    Warning: 使用这个函数要注意回收资源，及时清理临时文件
    :param template_path: 模板文件路径（.docx 模板）
    :param context: 字典，包含模板变量
    :return: 生成的临时文件的完整路径（str）
    """
    # 1. 加载模板
    doc = DocxTemplate(template_path)

    # 2. 渲染模板
    doc.render(context)

    # 3. 创建临时文件（指定 .docx 后缀，不自动删除）
    with tempfile.NamedTemporaryFile(delete=False,prefix='ric_report_', suffix='.docx') as tmp_file:
        temp_path = tmp_file.name  # 获取临时文件路径

    # 4. 保存文档到临时路径
    doc.save(temp_path)

    # 5. 返回临时文件路径
    return temp_path

# 示例用法
if __name__ == "__main__":
    script_dir = os.path.dirname(os.path.abspath(__file__))
    template_path = os.path.join(script_dir, "template.docx")

    # 定义替换数据（支持 Jinja2 语法）
    context = {
        "resume_info":{},
        "name":"沃林出品",
        "analysis_start":"""该求职者整体面试表现流畅、结构清晰，对技术细节（如数据治理、数仓分层、问题排查）有一定掌握，能结合项目举例说明，展现出较强的学习能力和表达能力。然而，其背景存在若干疑点，可能引发面试官对其“培训班出身”的怀疑：

1. **教育与职业路径跳跃**：金融专业本科，却在毕业前快速转向大数据开发，且实习即参与较复杂的基金APP和电商数仓项目，缺乏过渡性经历，显得经验“速成”。
2. **项目深度存疑**：虽能描述技术方案（如数据倾斜处理、ID标准化），但细节偏模板化（如“加随机后缀”等常见解法），缺乏个性化思考或失败复盘，有照搬培训案例之嫌。
3. **公司信息模糊**：称就职于小型外包公司（注册资本100–200万），团队仅9人却承接完整数仓建设，且项目周期短（半年）、离职原因简单（“无新项目”），真实性待验证。
4. **知识体系局限**：对《华为数据治理之道》仅“了解简介”，未深入阅读，与其强调的“愿深耕华为治理体系”略显矛盾，暴露知识储备偏应试。

面试官虽未直接质疑，但通过追问“是否参与标准制定”“系统初期建设”“书籍阅读”等问题，已隐含对其实战经验和知识深度的考察。求职者回答较为套路，未能完全打消疑虑。总体判断：面试效果中上，但因背景与表述存在“培训班典型特征”，已引起面试官潜在怀疑。
""",
  "对话总轮数": 28,
  "是否有完整流程": False,
  "学生发言占比": "62%",
  "技术问题数量": 5,
  "问题难度": "中等",
  "学生回答深度": "较深，能结合基金APP和电商项目说明数据治理实践，包括格式统一、ID标准化、数据倾斜处理等，并引用华为治理体系框架进行结构化阐述",
  "技术匹配度": "中高，岗位强调数据治理与AI训练数据准备，学生虽以离线数仓开发为主，但对治理理念（盘规治用）、元数据、质量维度有理解，具备迁移基础",
  "是否主动介绍项目": True,
  "项目描述清晰度": "清晰，明确说明两个项目背景（基金APP、中小电商数仓）、个人角色（数据开发）、技术栈（Oracle/Hive/Doris）、分层架构（ODS-DWD-DWS-ADS）及具体产出（九指标、漏斗转化率）",
  "项目与岗位匹配度": "中等偏上，项目聚焦数据开发与基础治理，虽未直接涉及CRM或AI数据集，但展示了数据标准、质量修复、建模能力，与‘数据管家’职责部分契合",
  "项目难点与解决": "详细描述三大挑战：数据倾斜（加随机后缀拆分聚合）、数据发散（ID格式统一+去重）、数据漂移（时区修正），并说明解决思路与效果",
  "语言表达清晰度": "整体流畅，偶有“就是”“然后”等口语词，但不影响逻辑传达；语速适中，条理清楚",
  "逻辑结构": "多数回答采用结构化表达，如‘三类问题’‘五层架构’‘盘规治用’，体现总分总思维",
  "互动与反馈": "能根据面试官追问调整内容深度，如从具体案例上升到治理框架，但在被问及书籍阅读时坦承未细读，略显准备不足",
  "语言专业度": "使用‘星型模型’‘维度建模’‘数据倾斜’‘元数据’等术语恰当，解释清晰，无堆砌",
  "面试官追问深度": "中等，围绕数据治理展开多轮追问（标准制定、构建态/运行态、团队协作、挑战），但未深入技术细节如SQL优化或监控工具实现",
  "面试官引导性语言": "较少，基本为事实性提问，无明显鼓励或肯定语句（如‘很好’‘不错’）",
  "是否给学生表达空间": "是，学生多次长篇回答（如自我介绍、治理理解、项目架构），面试官未打断",
  "是否提问": False,
  "问题质量": "无提问，错失展示兴趣与思考的机会",
  "是否体现岗位兴趣": "有限，虽表示愿意学习华为体系，但未主动询问业务细节、团队构成或AI数据准备相关内容",
  "岗位匹配度": "中等，技术栈覆盖岗位要求的数仓与治理基础，但缺乏CRM领域经验及AI数据处理实践；职业规划稳定，意愿明确",
  "整体印象": "踏实、逻辑清晰、具备扎实的数据开发基础和初步治理意识，表达有条理，但主动性稍弱（未提问、未深读推荐书籍），对AI相关方向准备不足",
  "面试成功率预测": "中等（约60%），可进入下一轮考察实操能力，但需验证其在分析侧开发与AI数据场景的适应性",
        "basic_report_json":[
  {
    "question": "能不能结合具体例子，说说你在数据治理方面做过哪些工作？比如遇到过哪些数据质量问题或架构标准问题，你具体做了什么？",
    "answer": "我在基金APP项目中遇到两个数据库——万得和聚源——的数据不一致问题。一是交易时间格式不同：聚源是标准时间格式，万得是字符串格式。我们统一用to_char(yyyymmdd)将聚源转为字符串格式。二是基金代码不一致：万得是“数字.of”格式，聚源是纯数字。我们用正则表达式截取数字部分，统一为纯数字编码。在电商项目中，也遇到商品ID如“P001”和“001”并存的问题，导致数据发散。我们同样用正则去掉前缀字母，保留纯数字，并通过WHERE条件去重，只保留最新一条记录。",
    "analysis": "回答结构清晰，列举了两个项目中典型的数据质量问题（时间格式、基金代码、商品ID），并说明了解决方法（to_char、正则表达式、去重逻辑），体现了实际动手能力。\n缺乏对问题影响的量化描述（如不一致导致报表错误率多少？业务损失？），也未体现是否推动形成标准或流程固化。例如，统一后的格式是否写入数据字典？是否有校验规则防止再次出现？\n建议补充：① 问题造成的业务影响；② 解决方案是否沉淀为规范（如ETL脚本模板、数据清洗规则库）；③ 是否通过元数据或质量监控工具实现长效治理。"
  },
  {
    "question": "你有没有参与过系统建设初期的数据标准或模型设计？比如和业务一起识别质量问题、制定标准？",
    "answer": "有的。我们在建模时采用了星型模型——一个事实表加多个维度表。我也参与过数据质量标准的讨论，比如字段粒度统一、计算逻辑一致、维度对齐等。不过主要设计由架构师和项目经理主导，我们作为开发人员参与讨论。",
    "analysis": "回答体现了对建模方法（星型模型）和数据质量要素（粒度、逻辑、维度）的基本理解，也坦诚说明了自身角色边界。\n但‘参与讨论’较为模糊，缺乏具体贡献实例。例如：是否提出过某字段定义建议被采纳？是否协助梳理过业务指标口径？是否推动某标准落地到DDL或ETL脚本？\n建议补充：① 具体参与的标准制定内容；② 与业务方沟通的实例；③ 自己提出的建议如何被纳入设计文档或技术实现，以体现主动性和影响力。"
  },
  {
    "question": "我们这个岗位叫“数据管家”，兼具数据架构师职责，要对整个信息化系统的数据全生命周期负责。你能不能讲讲你对数据治理的理解？构建态和运行态的关键点有哪些？",
    "answer": "我认为数据治理核心是“盘、规、治、用”：- **盘**：盘点数据源、标准、链路；- **规**：制定数据标准体系；- **治**：建立事前标准、事中监控、事后分析修复机制；- **用**：释放数据价值，支撑应用。参考华为的数据治理体系，它是业务驱动、价值为纲，由业务系统负责人作为Owner，数据管家执行治理。关键包括：- **事前**：统一字段命名，避免一词多义或同词多义；统一计算逻辑；做好维度建模；确保数据的**唯一性**（如商品ID主键唯一）、**有效性**（如销量≤库存）、**完整性**（关键字段如客户名称、电话不能缺失）。- **事中**：监控数仓运行流程，确保各层表字段数量、列名一致，保证**一致性**。- **事后**：问题溯源、按业务规则修复、输出治理报告，并将成果纳入KPI考核。此外还有元数据管理：业务元数据（数据源、业务含义）、技术元数据（表结构）、操作元数据（操作人、时间）。",
    "analysis": "整体框架完整，引用‘盘规治用’和华为实践，体现出对行业方法论的了解；能区分构建态（事前标准、建模）与运行态（事中监控、事后修复），并覆盖数据质量六大维度（唯一性、完整性、有效性、一致性等）及元数据分类，理论基础扎实。\n但略显‘教科书式’，缺少与自身项目经验的结合。例如：在电商项目中如何落实‘事前命名规范’？是否真的将治理结果纳入KPI？‘业务Owner机制’在实际协作中是否顺畅？\n建议强化‘知行合一’：将每个治理要点对应到自己做过的具体动作，避免泛泛而谈，以增强说服力和岗位匹配度。"
  },
  {
    "question": "介绍一下你的项目团队构成、你的角色、上下游协作情况。",
    "answer": "以电商项目为例：团队共9人——1名数据架构师兼项目经理、3名数据开发（含我）、2名数据分析师、1名BI工程师、1名测试、1名运维。项目背景：客户是中小电商，原用Excel手工同步，数据量增大后建数仓。我加入时项目刚启动约两个月，处于0→1阶段。数仓分五层：1. **ODS**：贴源层，保留原始数据，加抽取时间和系统标识，便于溯源；2. **DWD**：明细层，做清洗、格式统一、脏数据过滤，建维度表和事实表；3. **DWS**：聚合层，按日粒度轻度汇总，分主题域（我负责商品域和用户域）；4. **Doris层**：将DWD/DWS数据ETL至Doris，提升查询效率；5. **ADS**：应用层，在Doris上输出标准化指标和报表，供管理层使用。",
    "analysis": "团队结构、项目背景、数仓分层描述清晰，能准确使用专业术语（ODS/DWD/DWS/ADS），并明确自身负责范围（商品域、用户域），体现良好的架构意识和职责认知。\n但对‘上下游协作’着墨不足。例如：与分析师如何对齐指标口径？与BI工程师如何交接报表需求？是否参与需求评审？如何响应业务方的数据疑问？\n建议补充协作细节：① 与上游（业务/源系统）如何确认数据含义；② 与下游（分析/BI）如何交付和验证数据；③ 是否建立过SLA或数据服务接口，以展现端到端协同能力。"
  },
  {
    "question": "项目中遇到过哪些关键挑战？",
    "answer": "主要有三类问题：1. **数据倾斜**：分析商品漏斗转化率时，爆款商品点击量极大，导致Reduce阶段卡在99%。我们通过日志定位热点Key，采用“给商品ID加随机后缀→拆分→聚合→合并”方式解决。2. **数据发散**：商品ID存在“P001”和“001”两种形式，统一格式并去重后解决。3. **数据漂移**：用户登录时间用UTC，导致22–23点行为被记到次日。我们统一转换为北京时间（UTC+8）修正。日均数据量约1000万条。",
    "analysis": "问题类型典型（倾斜、发散、漂移），解决方案具体可行，尤其数据倾斜处理思路正确（打散+二次聚合），体现出较强的技术实战能力；补充日均数据量有助于评估问题复杂度。\n但可进一步突出‘治理思维’：例如，数据发散问题是否在源头系统推动改造？时间漂移是否推动埋点规范统一？是否建立监控告警防止复发？\n建议强调‘从救火到防火’的转变：除解决当前问题外，是否推动建立预防机制（如数据接入校验规则、埋点SDK规范、质量巡检任务），以契合‘数据管家’的长期治理定位。"
  }
]
}
    output_path = generate_doc_with_jinja(template_path, context)
    res = json.loads("""[{"question": "能不能结合具体例子"
    ,"answer": "我在基金APP一用to_c"
    ,"analysis": "回答结构清晰，列举辑），体现了实际动手能力。\\n缺乏对问题动形止范"}]""")
    print(res)
    print(f"已生成文件: {output_path}")